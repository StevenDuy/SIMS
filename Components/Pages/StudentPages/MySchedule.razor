@page "/my-schedule"
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using SIMS.Data
@attribute [Authorize(Roles = "Student")]
@rendermode InteractiveServer
@inject IDbContextFactory<SIMS.Data.ApplicationDbContext> DbFactory
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject UserManager<ApplicationUser> UserManager

<PageTitle>My Schedule</PageTitle>
<link rel="stylesheet" href="app.css" />

<div class="app-container animate-fade-in">
    <div class="page-header">
        <div class="header-content">
            <h1>My Schedule</h1>
            <div class="text-muted">Weekly Timetable & Attendance Status</div>
        </div>

        <div class="d-flex gap-2">
            <button class="btn btn-warning text-dark fw-bold shadow-sm" @onclick="ToggleReport">
                <i class="fa-solid fa-chart-pie"></i> Absence Report
            </button>

            <div class="d-flex gap-2 align-items-center bg-white p-1 rounded border shadow-sm">
                <button class="btn btn-sm btn-light" @onclick="PrevWeek"><i class="fa-solid fa-chevron-left"></i></button>
                <div class="fw-bold px-2" style="min-width: 120px; text-align: center;">
                    @CurrentWeekStart.ToString("dd/MM") - @CurrentWeekEnd.ToString("dd/MM")
                </div>
                <button class="btn btn-sm btn-light" @onclick="NextWeek"><i class="fa-solid fa-chevron-right"></i></button>
            </div>
        </div>
    </div>

    @if (ShowReport)
    {
        <div class="card-modern mb-4 border-warning" style="border-left: 5px solid #f59e0b;">
            <h4 class="mb-3">Attendance Summary</h4>
            @if (AbsenceStats == null)
            {
                <div>Loading stats...</div>
            }
            else if (!AbsenceStats.Any())
            {
                <div>No course data available.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Total Sessions</th>
                                <th>Absent</th>
                                <th>Absence %</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var stat in AbsenceStats)
                            {
                                <tr class="@(stat.Percentage > 20 ? "table-danger" : "")">
                                    <td>@stat.CourseName</td>
                                    <td>@stat.TotalSessions</td>
                                    <td>@stat.AbsentSessions</td>
                                    <td>@stat.Percentage.ToString("F1")%</td>
                                    <td>
                                        @if (stat.Percentage > 20)
                                        {
                                            <span class="badge bg-danger">Critical</span>
                                        }
                                        else
                                        {

                                            <span class="badge bg-success">Good</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    <div class="text-muted small">* Warning: Absence > 20% may result in failure.</div>
                </div>
            }
        </div>
    }

    @if (IsLoading)
    {
        <div class="p-5 text-center text-muted">
            <i class="fa-solid fa-spinner fa-spin fa-2x mb-3"></i>
            <p>Loading...</p>
        </div>
    }
    else if (!WeeklySchedules.Any())
    {
        <div class="card-modern text-center p-5 text-muted">
            <i class="fa-regular fa-calendar-check fa-2x mb-3"></i>
            <p>No classes scheduled for this week.</p>
        </div>
    }
    else
    {
        <div class="schedule-grid">
            @foreach (var dayGroup in WeeklySchedules.GroupBy(s => s.Date).OrderBy(g => g.Key))
            {
                var isToday = dayGroup.Key == DateOnly.FromDateTime(DateTime.Now);
                <div class="card-modern schedule-card @(isToday ? "is-today" : "")">
                    <div class="schedule-header-strip @(isToday ? "is-today" : "")"></div>
                    <div class="schedule-content">
                        <h3 class="schedule-day-title">
                            <span>@dayGroup.Key.DayOfWeek (@dayGroup.Key.ToString("dd/MM"))</span>
                            @if (isToday)
                            {
                                <span class="badge bg-primary fs-6">Today</span>
                            }
                        </h3>

                        <div class="session-list">
                            @foreach (var item in dayGroup.OrderBy(x => x.StartTime))
                            {
                                var isAbsent = MyAbsences.Contains(item.Id);

                                <div class="session-item" style="@(isAbsent ? "background: #fff5f5; border: 1px solid #feb2b2;" : "")">
                                    <div class="session-info-left">
                                        <div class="time-block">
                                            <div class="time-start">@item.StartTime.ToString("HH:mm")</div>
                                            <div class="time-end">to @item.EndTime.ToString("HH:mm")</div>
                                        </div>
                                        <div class="course-details">
                                            <div class="course-name">
                                                @(item.Course?.Name ?? "Unknown")
                                                @if (isAbsent)
                                                {
                                                    <span class="badge bg-danger ms-2">ABSENT</span>
                                                }
                                            </div>
                                            <div class="subject-name">
                                                <i class="fa-solid fa-chalkboard-user"></i>
                                                @(item.Course?.Lecture?.Name ?? "N/A")
                                            </div>
                                        </div>
                                    </div>
                                    <div class="room-badge">
                                        <i class="fa-solid fa-location-dot"></i> @item.Room
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<Schedule> WeeklySchedules { get; set; } = new();
    private bool IsLoading { get; set; } = true;
    private HashSet<int> MyAbsences { get; set; } = new();

    private DateOnly CurrentWeekStart;
    private DateOnly CurrentWeekEnd;

    private bool ShowReport { get; set; } = false;
    private List<AbsenceStat>? AbsenceStats;

    protected override async Task OnInitializedAsync()
    {
        var today = DateOnly.FromDateTime(DateTime.Now);
        int diff = (int)today.DayOfWeek - (int)DayOfWeek.Monday;
        if (diff < 0) diff += 7;
        CurrentWeekStart = today.AddDays(-diff);
        CurrentWeekEnd = CurrentWeekStart.AddDays(6);

        await LoadData();
    }

    private async Task LoadData()
    {
        IsLoading = true;
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);

        if (user != null)
        {
            using var context = DbFactory.CreateDbContext();

            var enrolledIds = await context.Enrollments
                .Where(e => e.StudentId == user.Id)
                .Select(e => e.CourseId)
                .ToListAsync();

            WeeklySchedules = await context.Schedules
                .Include(s => s.Course).ThenInclude(c => c!.Lecture)
                .Where(s => enrolledIds.Contains(s.CourseId) &&
                            s.Date >= CurrentWeekStart && s.Date <= CurrentWeekEnd)
                .OrderBy(s => s.Date).ThenBy(s => s.StartTime)
                .AsNoTracking()
                .ToListAsync();

            var scheduleIds = WeeklySchedules.Select(s => s.Id).ToList();
            var abs = await context.Attendances
                .Where(a => a.StudentId == user.Id && scheduleIds.Contains(a.ScheduleId) && a.IsAbsent)
                .Select(a => a.ScheduleId)
                .ToListAsync();
            MyAbsences = abs.ToHashSet();
        }
        IsLoading = false;
    }

    private async Task ToggleReport()
    {
        ShowReport = !ShowReport;
        if (ShowReport && AbsenceStats == null) await LoadStats();
    }

    private async Task LoadStats()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = await UserManager.GetUserAsync(authState.User);
        if (user == null) return;

        using var context = DbFactory.CreateDbContext();

        var enrollments = await context.Enrollments
            .Include(e => e.Course)
            .Where(e => e.StudentId == user.Id)
            .ToListAsync();

        AbsenceStats = new List<AbsenceStat>();

        foreach (var enroll in enrollments)
        {
            var total = await context.Schedules.CountAsync(s => s.CourseId == enroll.CourseId);
            var absent = await context.Attendances
                .Include(a => a.Schedule)
                .CountAsync(a => a.StudentId == user.Id && a.Schedule!.CourseId == enroll.CourseId && a.IsAbsent);

            if (total > 0)
            {
                AbsenceStats.Add(new AbsenceStat
                {
                    CourseName = enroll.Course?.Name ?? "Unknown",
                    TotalSessions = total,
                    AbsentSessions = absent
                });
            }
        }
    }

    private async Task PrevWeek() { CurrentWeekStart = CurrentWeekStart.AddDays(-7); CurrentWeekEnd = CurrentWeekEnd.AddDays(-7); await LoadData(); }
    private async Task NextWeek() { CurrentWeekStart = CurrentWeekStart.AddDays(7); CurrentWeekEnd = CurrentWeekEnd.AddDays(7); await LoadData(); }

    public class AbsenceStat
    {
        // Fix lỗi CS8618: Khởi tạo giá trị mặc định
        public string CourseName { get; set; } = string.Empty;
        public int TotalSessions { get; set; }
        public int AbsentSessions { get; set; }
        public double Percentage => TotalSessions == 0 ? 0 : ((double)AbsentSessions / TotalSessions) * 100;
    }
}