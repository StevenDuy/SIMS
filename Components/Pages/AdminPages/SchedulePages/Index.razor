@page "/schedules"
@using Microsoft.EntityFrameworkCore
@using SIMS.Data
@using System.Globalization
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]
@rendermode InteractiveServer
@inject IDbContextFactory<SIMS.Data.ApplicationDbContext> DbFactory

<PageTitle>Schedule Management</PageTitle>
<link rel="stylesheet" href="app.css" />

<div class="app-container animate-fade-in">
    <div class="page-header">
        <div class="header-content">
            <h1>Schedule Management</h1>
            <div class="text-muted">Manage timetable & Attendance</div>
        </div>

        <div style="display: flex; gap: 10px; align-items: center;">
            <button class="btn btn-outline-secondary btn-sm" @onclick="PrevWeek">
                <i class="fa-solid fa-chevron-left"></i>
            </button>
            <div class="fw-bold border rounded px-3 py-1 bg-white shadow-sm" style="min-width: 150px; text-align: center;">
                @CurrentWeekStart.ToString("dd/MM") - @CurrentWeekEnd.ToString("dd/MM")
            </div>
            <button class="btn btn-outline-secondary btn-sm" @onclick="NextWeek">
                <i class="fa-solid fa-chevron-right"></i>
            </button>

            <a href="/schedules/create" class="btn btn-primary btn-sm ms-2 hover-lift">
                <i class="fa-solid fa-plus"></i> Create
            </a>
        </div>
    </div>

    <div class="table-container">
        @if (WeeklySchedules == null)
        {
            <div class="p-5 text-center text-muted">
                <div class="spinner-border text-primary mb-3" role="status"></div>
                <p>Loading schedules...</p>
            </div>
        }
        else if (!WeeklySchedules.Any())
        {
            <div class="p-5 text-center text-muted border rounded bg-light">
                <i class="fa-regular fa-calendar-xmark fa-2x mb-3"></i>
                <p>No classes scheduled for this week.</p>
            </div>
        }
        else
        {
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Course</th>
                            <th>Lecturer</th>
                            <th>Room</th>
                            <th>Attendance</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var s in WeeklySchedules)
                        {
                            <tr>
                                <td>
                                    <div class="fw-bold text-primary">@s.Date.ToString("dd/MM/yyyy")</div>
                                    <div class="small text-muted">@s.Date.DayOfWeek</div>
                                </td>

                                <td>
                                    <span class="badge bg-light text-dark border">
                                        @s.StartTime.ToString("HH:mm") - @s.EndTime.ToString("HH:mm")
                                    </span>
                                </td>

                                <td>
                                    <div class="fw-bold">@s.Course?.Name</div>
                                    <div class="small text-muted">Code: @(s.Course?.Code ?? "N/A")</div>
                                </td>

                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="fa-solid fa-user-tie text-secondary"></i>
                                        <span>@(s.Course?.Lecture?.Name ?? "Unassigned")</span>
                                    </div>
                                </td>

                                <td>
                                    <span class="badge bg-info text-dark">@s.Room</span>
                                </td>

                                <td>
                                    @if (s.IsAttendanceTaken)
                                    {
                                        <span class="badge bg-success"><i class="fa-solid fa-check"></i> Taken</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-secondary">Pending</span>
                                    }
                                </td>

                                <td>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-sm btn-outline-primary" @onclick="() => OpenAttendanceModal(s)" title="Manage Attendance">
                                            <i class="fa-solid fa-clipboard-user"></i>
                                        </button>

                                        <a href="@($"/schedules/edit?id={s.Id}")" class="btn btn-sm btn-outline-secondary" title="Edit">
                                            <i class="fa-solid fa-pen"></i>
                                        </a>

                                        <a href="@($"/schedules/delete?id={s.Id}")" class="btn btn-sm btn-outline-danger" title="Delete">
                                            <i class="fa-solid fa-trash"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }
    </div>
</div>

@if (ShowModal)
{
    <div class="modal-backdrop-custom">
        <div class="modal-content-custom animate-fade-in">
            <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
                <h5 class="m-0">Attendance Check (Admin)</h5>
                <button class="btn-close" @onclick="CloseModal"></button>
            </div>

            <div class="alert alert-light border mb-3">
                <div class="fw-bold text-primary">@SelectedSchedule?.Course?.Name</div>
                <div class="small">
                    @SelectedSchedule?.Date.ToString("dd/MM/yyyy") |
                    @SelectedSchedule?.StartTime - @SelectedSchedule?.EndTime
                </div>
            </div>

            @if (ClassEnrollments == null)
            {
                <div class="text-center py-3">
                    <div class="spinner-border spinner-border-sm text-primary"></div> Loading students...
                </div>
            }
            else if (!ClassEnrollments.Any())
            {
                <div class="alert alert-warning">No students enrolled in this class.</div>
            }
            else
            {
                <div class="student-list-grid" style="max-height: 400px; overflow-y: auto;">
                    @foreach (var enroll in ClassEnrollments)
                    {
                        var isAbsent = Absences.Contains(enroll.StudentId);
                        <div class="d-flex justify-content-between align-items-center p-2 border rounded mb-2 @(isAbsent ? "bg-danger-subtle border-danger" : "bg-white")">
                            <div>
                                <div class="fw-bold">@enroll.Student?.Name</div>
                                <div class="small text-muted">@enroll.Student?.Email</div>
                            </div>
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" checked="@isAbsent"
                                       @onchange="(e) => ToggleAbsence(enroll.StudentId, e.Value)" />
                                <label class="form-check-label small fw-bold @(isAbsent ? "text-danger" : "text-muted")">
                                    @(isAbsent ? "Absent" : "Present")
                                </label>
                            </div>
                        </div>
                    }
                </div>
            }

            <div class="modal-footer pt-3 mt-0 border-top">
                <button class="btn btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn btn-primary" @onclick="SaveAttendance">
                    <i class="fa-solid fa-save"></i> Save Changes
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<Schedule>? WeeklySchedules;
    private DateOnly CurrentWeekStart;
    private DateOnly CurrentWeekEnd;

    // Modal Variables
    private bool ShowModal = false;
    private Schedule? SelectedSchedule;
    private List<Enrollment>? ClassEnrollments;
    private HashSet<string> Absences = new();

    protected override async Task OnInitializedAsync()
    {
        // 1. Tính toán ngày đầu tuần (Thứ 2) và cuối tuần (Chủ nhật) của tuần hiện tại
        var today = DateOnly.FromDateTime(DateTime.Now);
        int diff = (int)today.DayOfWeek - (int)DayOfWeek.Monday;
        if (diff < 0) diff += 7; // Xử lý trường hợp chủ nhật
        CurrentWeekStart = today.AddDays(-diff);
        CurrentWeekEnd = CurrentWeekStart.AddDays(6);

        await LoadSchedules();
    }

    private async Task LoadSchedules()
    {
        using var context = DbFactory.CreateDbContext();

        // 2. Lấy dữ liệu lịch học CHỈ TRONG TUẦN ĐANG CHỌN
        WeeklySchedules = await context.Schedules
            .Include(s => s.Course).ThenInclude(c => c.Lecture)
            .Where(s => s.Date >= CurrentWeekStart && s.Date <= CurrentWeekEnd)
            .OrderBy(s => s.Date)
            .ThenBy(s => s.StartTime)
            .AsNoTracking()
            .ToListAsync();
    }

    // --- Logic Điều hướng Tuần ---
    private async Task PrevWeek()
    {
        CurrentWeekStart = CurrentWeekStart.AddDays(-7);
        CurrentWeekEnd = CurrentWeekEnd.AddDays(-7);
        await LoadSchedules();
    }

    private async Task NextWeek()
    {
        CurrentWeekStart = CurrentWeekStart.AddDays(7);
        CurrentWeekEnd = CurrentWeekEnd.AddDays(7);
        await LoadSchedules();
    }

    // --- Logic Điểm danh (Modal) ---
    private async Task OpenAttendanceModal(Schedule schedule)
    {
        SelectedSchedule = schedule;
        ShowModal = true;
        Absences.Clear();
        ClassEnrollments = null;

        using var context = DbFactory.CreateDbContext();

        // Lấy danh sách sinh viên lớp đó
        ClassEnrollments = await context.Enrollments
            .Include(e => e.Student)
            .Where(e => e.CourseId == schedule.CourseId)
            .OrderBy(e => e.Student!.Name)
            .ToListAsync();

        // Lấy danh sách những người đã bị đánh vắng trước đó (nếu có)
        var existingAbsences = await context.Attendances
            .Where(a => a.ScheduleId == schedule.Id && a.IsAbsent)
            .Select(a => a.StudentId)
            .ToListAsync();

        foreach (var id in existingAbsences) Absences.Add(id);
    }

    private void ToggleAbsence(string studentId, object? isChecked)
    {
        if (isChecked is bool v && v) Absences.Add(studentId);
        else Absences.Remove(studentId);
    }

    private void CloseModal() => ShowModal = false;

    private async Task SaveAttendance()
    {
        if (SelectedSchedule == null) return;
        using var context = DbFactory.CreateDbContext();

        // 1. Cập nhật trạng thái "Đã điểm danh" cho lịch
        var scheduleDb = await context.Schedules.FindAsync(SelectedSchedule.Id);
        if (scheduleDb != null) scheduleDb.IsAttendanceTaken = true;

        // 2. Xóa hết dữ liệu điểm danh cũ của buổi này
        var oldRecs = await context.Attendances.Where(a => a.ScheduleId == SelectedSchedule.Id).ToListAsync();
        context.Attendances.RemoveRange(oldRecs);

        // 3. Thêm dữ liệu điểm danh mới (chỉ lưu người vắng)
        foreach (var id in Absences)
        {
            context.Attendances.Add(new Attendance
            {
                ScheduleId = SelectedSchedule.Id,
                StudentId = id,
                IsAbsent = true,
                Note = "Admin Marked"
            });
        }

        await context.SaveChangesAsync();
        ShowModal = false;
        await LoadSchedules(); // Tải lại để cập nhật trạng thái trên bảng
    }
}